--- aurora-1.9.0/comm.c	2015-09-26 20:56:09.001758260 +0200
+++ my-aurora-1.9.0/comm.c	2015-10-15 16:29:42.000000000 +0200
@@ -1816,7 +1816,7 @@
         attempts++;
     }
     if (CRCrc < 0) return(-1);
-    if (bRptReties) {
+    if (bRptRetries) {
         fprintf(stderr, "\n%s: %s: %i attempts made",getCurTime(),ProgramName,attempts-1);
         if (bVerbose) fprintf(stderr, "\n");
     } else
--- aurora-1.9.0/include/main.h	2015-01-27 02:38:07.596037510 +0100
+++ my-aurora-1.9.0/include/main.h	2015-10-15 16:33:16.000000000 +0200
@@ -62,7 +62,7 @@
 extern BOOL bCommCheck;
 extern BOOL bColOutput;
 extern BOOL bCalcGridPwr;
-extern BOOL bRptReties;
+extern BOOL bRptRetries;
 extern BOOL bRptReadPause;
 extern BOOL bSwapEndian;
 extern BOOL bUseMultiplierQ;
--- install-aurora/aurora-1.9.0/main.c	2015-09-26 20:55:46.215899208 +0200
+++ my-aurora-1.9.0/main.c	2015-10-15 16:58:53.000000000 +0200
@@ -80,6 +80,7 @@
 #include <sys/types.h>
 #include <sys/stat.h>
 #include <sys/time.h>
+#include <sys/file.h>
 #include <fcntl.h>
 #include <termios.h>
 #include <stdio.h>
@@ -112,7 +113,7 @@
 BOOL bCalcGridPwr = FALSE;
 BOOL bXonXoff = FALSE;
 BOOL bRTSCTS = FALSE;
-BOOL bRptReties = FALSE;
+BOOL bRptRetries = FALSE;
 BOOL bRptReadPause = FALSE;
 BOOL bSwapEndian = FALSE;
 BOOL bUseMultiplierQ = FALSE;
@@ -169,9 +170,10 @@
 /* local functions */
 static int GetParms(int argc, char *argv[]);
 static void *getMemPtr(size_t mSize);
+static void *reallocMemPtr(void *buffer, size_t mSize);
 static void Version();
-static int getPIDcmdLen(long unsigned int PID);
-static void getPIDcmd(long unsigned int PID, char* COMMAND);
+static void *getPIDcmd(long unsigned int PID);
+static void AddSerLock(long unsigned int PID, char *COMMAND);
 
 /*--------------------------------------------------------------------------
     getCurTime
@@ -191,69 +193,38 @@
 }
 
 /*--------------------------------------------------------------------------
-    getPIDcmdLen
-----------------------------------------------------------------------------*/
-int getPIDcmdLen(long unsigned int PID)
-{
-    FILE *fdserlck = NULL;
-    int fLen = 0;
-    char sPID[10];
-    char *cmdFile = NULL;
-
-    sPID[0] = '\0';
-    sprintf(sPID,"%lu",PID);
-    cmdFile = getMemPtr(strlen(sPID)+14+1);
-    cmdFile[0] = '\0';
-    sprintf(cmdFile,"/proc/%lu/cmdline",PID);
-    cmdFile[strlen(cmdFile)] = '\0';
-    fdserlck = fopen(cmdFile, "r");
-    if (fdserlck != NULL) {
-        while (fgetc(fdserlck) != EOF) fLen++;
-        fclose(fdserlck);
-        fdserlck = NULL;
-    }
-    if (cmdFile != NULL) {
-        free(cmdFile);
-        cmdFile = NULL;
-    }
-    return fLen;
-}
-
-
-/*--------------------------------------------------------------------------
     getPIDcmd
 ----------------------------------------------------------------------------*/
-void getPIDcmd(long unsigned int PID, char* COMMAND)
+void *getPIDcmd(long unsigned int PID)
 {
-    FILE *fdserlck = NULL;
-    int bRead = 0;
-    int fLen = 0;
-    char sPID[10];
+    FILE *fdcmd = NULL;
+    char *COMMAND = NULL;
+    size_t bufLen = 64, 
+           chunk = 32, 
+           cmdLen = 0;
+    char c;
+    char sPID[16];
     char *cmdFile = NULL;
 
-    sPID[0] = '\0';
     sprintf(sPID,"%lu",PID);
     cmdFile = getMemPtr(strlen(sPID)+14+1);
-    cmdFile[0] = '\0';
     sprintf(cmdFile,"/proc/%lu/cmdline",PID);
-    cmdFile[strlen(cmdFile)] = '\0';
-    fLen = getPIDcmdLen(PID);
-    if (fLen > 0) {
-        fdserlck = fopen(cmdFile, "r");
-        if (fdserlck != NULL) {
-            COMMAND[0] = '\0';
-            bRead = fscanf(fdserlck, "%s", COMMAND);
-            if (bRead) COMMAND[strlen(COMMAND)] = '\0';
-            fclose(fdserlck);
-            fdserlck = NULL;
+    
+    fdcmd = fopen(cmdFile, "r");
+    if (fdcmd != NULL) {
+        COMMAND = getMemPtr(bufLen);
+        for (c=fgetc(fdcmd); c != EOF; c=fgetc(fdcmd)) {
+            COMMAND[cmdLen++] = c;
+            if (c==0) break;
+            if (cmdLen>=bufLen)
+                COMMAND = reallocMemPtr(COMMAND, bufLen+chunk);
         }
+        fclose(fdcmd);
     }
-    if (cmdFile != NULL) {
         free(cmdFile);
-        cmdFile = NULL;
-    }
-}
 
+    return COMMAND;
+}
 
 /*--------------------------------------------------------------------------
     main
@@ -269,7 +240,8 @@
     char RunTime[18] = " ";
     char EndTime[18] = " ";
     long unsigned int LckPID;
-    int bRead, bWrite, lckCNT;
+    struct timeval tLockStart, tLockNow;
+    int bRead, lckCNT;
     int errno_save = 0;
     int fLen = 0;
     int curChar = 0;
@@ -379,7 +351,7 @@
         printf(" -X, --rts-cts                  Enable RTS/CTS on the serial port.\n");
 	printf(" -x, --xon-xoff                 Enable XON/XOFF on the serial port.\n");
         printf(" -Y <num>, --retries=<num>      Retry failed communications with inverter up to <num> times (1-100)\n");
-        printf(" -y, --rpt-retries              Report the number of retires done\n\n");
+        printf(" -y, --rpt-retries              Report the number of retries done\n\n");
         printf("               *** Required Parameters ***\n");
         printf(" -a <num>, --address=<num>      Inverter address. 1-31 on older inverters, 1-63 on newer inverters.\n");
         printf(" Device                         Serial Device.\n");
@@ -413,31 +385,18 @@
         exit(0);
     }
 
-    fLen = getPIDcmdLen(PID);
-    COMMAND = getMemPtr(fLen+1);
-    getPIDcmd(PID,COMMAND);
-
-    if (bVerbose) fprintf(stderr, "\nAttempting to get lock on Serial Port %s...\n",szttyDevice);
-    fdserlck = fopen((const char *)devLCKfile, "a");
-    if (fdserlck == NULL) {
-        if (bVerbose) fprintf(stderr, "\n");
-        fprintf(stderr, "%s: %s: Problem locking serial device, can't open lock file: %s for write.\n\n",getCurTime(),ProgramName,devLCKfile);
-        exit(2);
-    }
-    bWrite = fprintf(fdserlck, "%lu %s\n", PID, COMMAND);
-    errno_save = errno;
-    fclose(fdserlck);
-    fdserlck = NULL;
-    if (bWrite < 0 || errno_save != 0) {
-        if (bVerbose) fprintf(stderr, "\n");
-        fprintf(stderr, "%s: %s: Problem locking serial device, can't write lock file: %s.\n%s\n\n",getCurTime(),ProgramName,devLCKfile,strerror (errno_save));
-        exit(2);
-    }
+    COMMAND = getPIDcmd(PID);
+    AddSerLock(PID, COMMAND);
 
     LckPID = 0;
     lckCNT = -1;
     lckCNTbeg = TRUE;
-    while(LckPID != PID && lckCNT++ < yLockWait) {
+
+    gettimeofday(&tLockStart, NULL);
+    tLockNow=tLockStart;
+    
+    while(LckPID != PID &&
+          tLockNow.tv_sec*1000+tLockNow.tv_usec/1000 < tLockStart.tv_sec*1000 + tLockStart.tv_usec/1000 + yLockWait*1000) {
         if (bVerbose && lckCNT == 0 && lckCNTbeg) {
             fprintf(stderr, "Checking for lock\n");
             lckCNTbeg = FALSE;
@@ -452,12 +411,13 @@
         fLen = 0;
         while ((curChar = fgetc(fdserlck)) != EOF && curChar != '\n' && curChar != ' ') fLen++;
         fLen = 0;
-        while ((curChar = fgetc(fdserlck)) != EOF && curChar != '\n') fLen++;
+        if (curChar != '\n') while ((curChar = fgetc(fdserlck)) != EOF && curChar != '\n') fLen++;
+        
         rewind(fdserlck);
         LckCOMMAND = getMemPtr(fLen+1);
         LckCOMMAND[0] = '\0';
 
-        bRead = fscanf(fdserlck, "%lu %s", &LckPID, LckCOMMAND);
+        bRead = fscanf(fdserlck, "%lu[ ]%s\n", &LckPID, LckCOMMAND);
         errno_save = errno;
         fclose(fdserlck);
         if (bVerbose) fprintf(stderr, "\nChecking process %lu (%s) for lock\n", LckPID, LckCOMMAND);
@@ -468,9 +428,7 @@
             exit(2);
         }
 
-        fLen = getPIDcmdLen(LckPID);
-        LckPIDcommand = getMemPtr(fLen+1);
-        getPIDcmd(LckPID,LckPIDcommand);
+        LckPIDcommand = getPIDcmd(LckPID);
 
         if (bVerbose) {
             fprintf (stderr, "PID: %lu COMMAND: \"%s\" LckPID: %lu LckCOMMAND: \"%s\" LckPIDcommand \"%s\"", PID, COMMAND, LckPID, LckCOMMAND, LckPIDcommand);
@@ -483,13 +441,15 @@
 //	COMMAND       - this process
 //	LckCOMMAND    - process command from lock file
 //	LckPIDcommand - process command of process using PID from lock file
-        if ((PID != LckPID && LckPIDcommand == NULL) || strcmp(LckCOMMAND,LckPIDcommand) != 0 || strcmp(LckPIDcommand,"") == 0) {
+        if ((PID != LckPID && LckPIDcommand == NULL) || (LckCOMMAND[0]!='\0' && strcmp(LckPIDcommand,LckCOMMAND) != 0) || strcmp(LckPIDcommand,"") == 0) {
             if (bVerbose) fprintf (stderr, "\n");
             fprintf(stderr, "%s: %s: Clearing stale serial port lock. (%lu)\n",getCurTime(),ProgramName,LckPID);
             ClrSerLock(LckPID);
             lckCNT = -1;
-        } else if (yLockWait > 0)
-            sleep(1);
+        } else if (yLockWait > 0) {
+            if (bVerbose) fprintf(stderr, "Sleeping 25ms");
+            usleep(25000);
+        }
 
         if (LckCOMMAND != NULL) {
             free(LckCOMMAND);
@@ -499,6 +459,7 @@
             free(LckPIDcommand);
             LckPIDcommand = NULL;
         }
+        gettimeofday(&tLockNow, NULL);
     }
     free(COMMAND);
     if (bVerbose && LckPID == PID) fprintf(stderr, "Appears we got the lock.\n");
@@ -730,7 +691,7 @@
     ClrSerLock(PID);
 
     if (rc < 0) {
-        if (bRptReties) fprintf(stderr, "\n");
+        if (bRptRetries) fprintf(stderr, "\n");
         if (bVerbose) fprintf(stderr, "\n");
         fprintf(stderr, "%s: %s: ERROR: Received bad return code (%i %i",getCurTime(),ProgramName,rc,invOp);
         if (invFunc > 0)
@@ -755,31 +716,31 @@
 ----------------------------------------------------------------------------*/
 int RestorePort(int fdser) {
 
-    if (bVerbose) fprintf(stderr, "\nRestoring Serial Port settings %s...", szttyDevice);
-    if (tcsetattr(fdser, TCSANOW, &oldtio)) {		/* restore previous port settings */
+    if (bVerbose) { fprintf(stderr, "\nFlushing serial device buffer..."); }
+    errno = 0;
+    if (tcflush(fdser, TCIOFLUSH)) {
         if (bVerbose) fprintf(stderr, "\n");
-        fprintf(stderr, "%s: %s: Problem restoring serial device settings.\n",getCurTime(),ProgramName);
+        fprintf(stderr, "\n%s: %s: Problem flushing serial device: (%i) %s\n\n",getCurTime(),ProgramName,errno,strerror(errno));
         if (bVerbose) fprintf(stderr, "Closing Serial Port %s...",szttyDevice);
         if (close(fdser)) {
             if (bVerbose) fprintf(stderr, "\n");
-            fprintf(stderr, "%s: %s: Problem closing serial device, check device name.\n",getCurTime(),ProgramName);
+            fprintf(stderr, "%s: %s: Problem closing serial device.\n",getCurTime(),ProgramName);
         }
-        if (bVerbose) fprintf(stderr, " Success!\n");
+        if (bVerbose) { fprintf(stderr, " Success!\n"); }
         return 2;
     }
 
-    if (bVerbose) { fprintf(stderr, " Success!\nFlushing serial device buffer..."); }
+    if (bVerbose) fprintf(stderr, " Success!\nRestoring Serial Port settings %s...", szttyDevice);
 
-    errno = 0;
-    if (tcflush(fdser, TCIOFLUSH)) {
+    if (tcsetattr(fdser, TCSADRAIN, &oldtio)) {		/* restore previous port settings */
         if (bVerbose) fprintf(stderr, "\n");
-        fprintf(stderr, "\n%s: %s: Problem flushing serial device: (%i) %s\n\n",getCurTime(),ProgramName,errno,strerror(errno));
+        fprintf(stderr, "%s: %s: Problem restoring serial device settings.\n",getCurTime(),ProgramName);
         if (bVerbose) fprintf(stderr, "Closing Serial Port %s...",szttyDevice);
         if (close(fdser)) {
             if (bVerbose) fprintf(stderr, "\n");
-            fprintf(stderr, "%s: %s: Problem closing serial device.\n",getCurTime(),ProgramName);
+            fprintf(stderr, "%s: %s: Problem closing serial device, check device name.\n",getCurTime(),ProgramName);
         }
-        if (bVerbose) { fprintf(stderr, " Success!\n"); }
+        if (bVerbose) fprintf(stderr, " Success!\n");
         return 2;
     }
 
@@ -794,6 +755,53 @@
     return 0;
 }
 
+/*--------------------------------------------------------------------------
+    AddSerLock
+    Queue Serial Port lock intent.
+----------------------------------------------------------------------------*/
+void AddSerLock(long unsigned int PID, char *COMMAND) {
+    FILE *fdserlck;
+    int bWrite;
+    int errno_save = 0;
+    
+    if (bVerbose) fprintf(stderr, "\nAttempting to get lock on Serial Port %s...\n",szttyDevice);
+    do {
+      fdserlck = fopen((const char *)devLCKfile, "a");
+      if (fdserlck == NULL) {
+          if (bVerbose) fprintf(stderr, "\n");
+          fprintf(stderr, "%s: %s: Problem locking serial device, can't open lock file: %s for write.\n\n",getCurTime(),ProgramName,devLCKfile);
+          exit(2);
+      }
+        if (bVerbose) fprintf(stderr, "Acquiring shared lock on %s...\n",devLCKfile);
+        errno = 0;
+        
+        if (flock(fileno(fdserlck), LOCK_SH | LOCK_NB) == 0 ) break;      // Lock Acquired 
+        errno_save=errno;
+        
+        if (errno_save == EWOULDBLOCK) {
+            if (bVerbose) fprintf(stderr, "Whould block %s, retry (%d)...\n",devLCKfile, errno_save);
+            usleep(25000);
+            fclose(fdserlck);
+        } else {
+            fprintf(stderr, "%s: Problem locking serial device, can't open lock file: %s for write. (%d)\n",ProgramName,devLCKfile, errno_save);
+            exit(2);
+        }
+    } while (errno_save == EWOULDBLOCK);
+    if (bVerbose) fprintf(stderr, "Shared lock on %s acquired...\n",devLCKfile);
+
+    errno=0;
+    bWrite = fprintf(fdserlck, "%lu %s\n", PID, COMMAND);
+    errno_save = errno;
+    fclose(fdserlck);                   // Will release lock
+    fdserlck = NULL;
+    if (bWrite < 0 || errno_save != 0) {
+        if (bVerbose) fprintf(stderr, "\n");
+        fprintf(stderr, "%s: %s: Problem locking serial device, can't write lock file: %s.\n%s\n\n",getCurTime(),ProgramName,devLCKfile,strerror(errno_save));
+        exit(2);
+    }
+ }
+
+
 
 /*--------------------------------------------------------------------------
     ClrSerLock
@@ -818,7 +826,11 @@
         fprintf(stderr, "\n%s: %s: Problem opening serial device lock file to clear LckPID %lu: %s for read.\n\n",getCurTime(),ProgramName,LckPID,devLCKfile);
         return(0);
     }
-    fdserlcknew = fopen(devLCKfileNew, "w");
+    if (bVerbose) fprintf(stderr, "Acquiring exclusive lock on %s...\n",devLCKfile);
+    flock(fileno(fdserlck), LOCK_EX);   // Will wait to acquire lock then continue
+    if (bVerbose) fprintf(stderr, "Exclusive lock on %s acquired (%d)...\n",devLCKfile, errno);
+    
+    fdserlcknew = fopen(devLCKfileNew, "a");
     if (fdserlcknew == NULL) {
         if (bVerbose) fprintf(stderr, "\n");
         fprintf(stderr, "\n%s: %s: Problem opening new serial device lock file to clear LckPID %lu: %s for write.\n\n",getCurTime(),ProgramName,LckPID,devLCKfileNew);
@@ -826,6 +838,7 @@
         return(0);
     }
 
+    // Find cmdLen max len in file (?)
     curChar = 0;
     while (curChar != EOF) {
         fLen = 0;
@@ -838,28 +851,41 @@
 
     COMMAND = getMemPtr(cmdLen+1);
     COMMAND[0] = '\0';
-    bRead = fscanf(fdserlck, "%lu %s", &PID, COMMAND);
+    bRead = fscanf(fdserlck, "%lu[ ]%s\n", &PID, COMMAND);
+    errno_save = errno;
+    if (bVerbose) fprintf(stderr, "%s: errno=%i, bRead=%i PID=%lu LckPID=%lu\n", ProgramName, errno_save, bRead, PID, LckPID);
 
-    while (bRead != EOF) {
+    while (bRead != EOF && bRead>0) {
         if (PID != LckPID) {
             errno = 0;
+            if (COMMAND[0] != '\0') {
             bWrite = fprintf(fdserlcknew, "%lu %s\n", PID, COMMAND);
             errno_save = errno;
+            } else {
+                bWrite = fprintf(fdserlcknew, "%lu\n", PID);
+                errno_save = errno;
+            }
+            if (bVerbose) fprintf(stderr, "%s: errno=%i, bWrite=%i PID=%lu\n", ProgramName, errno, bWrite, PID);
             if (bWrite < 0 || errno_save != 0) {
                 fprintf(stderr, "\n%s: %s: Problem clearing serial device lock, can't write lock file: %s.\n%s\n\n",getCurTime(),ProgramName,devLCKfile,strerror (errno_save));
                 fclose(fdserlcknew);
                 return(0);
             }
         }
-        bRead = fscanf(fdserlck, "%lu %s", &PID, COMMAND);
+        COMMAND[0] = '\0';
+        bRead = fscanf(fdserlck, "%lu[ ]%s\n", &PID, COMMAND);
+        if (bVerbose) fprintf(stderr, "%s: errno=%i, bRead=%i PID=%lu LckPID=%lu\n", ProgramName, errno_save, bRead, PID, LckPID);
     }
-    fclose(fdserlck);
-    fclose(fdserlcknew);
-    free(COMMAND);
+    fflush(fdserlcknew);
+
     errno = 0;
     if (rename(devLCKfileNew,devLCKfile)) fprintf(stderr, "\n%s: %s: Problem clearing serial device lock, can't update lock file: %s.\n%s\n\n",getCurTime(),ProgramName,devLCKfile,strerror (errno));
     if (bVerbose) fprintf(stderr, " done.\n");
 
+    fclose(fdserlck);
+    fclose(fdserlcknew);
+    free(COMMAND);
+
     return -1;
 }
 
@@ -1166,7 +1192,7 @@
                     return 0;
                 }
                 break;
-            case 'y': bRptReties   = TRUE; break;
+            case 'y': bRptRetries   = TRUE; break;
             case 'V': bVersion     = TRUE; break;
             case 'v': bGetVer      = TRUE; break;
 
@@ -1227,19 +1253,30 @@
 void *getMemPtr(size_t mSize)
 {
     void *ptr;
-    char *cptr;
-    int i;
 
-    ptr = malloc(mSize);
+    ptr = calloc(sizeof(char), mSize);
     if (!ptr) {
-        fprintf(stderr, "\nvproweather: malloc failed\n");
+        fprintf(stderr, "\n%s: malloc failed\n", ProgramName);
         exit(2);
     }
-    cptr = (char *)ptr;
-    for (i = 0; i < mSize; i++) cptr[i] = '\0';
+//    memset(ptr, 0, mSize);
     return ptr;
 }
 
+/*--------------------------------------------------------------------------
+        reallocMemPtr
+----------------------------------------------------------------------------*/
+void *reallocMemPtr(void *buffer, size_t mSize)
+{
+    void *ptr;
+
+    ptr = realloc(buffer, mSize);
+    if (!ptr) {
+        fprintf(stderr, "\n%s: realloc failed\n", ProgramName);
+        exit(2);
+    }
+    return ptr;
+}
 
 /*--------------------------------------------------------------------------
     Version
